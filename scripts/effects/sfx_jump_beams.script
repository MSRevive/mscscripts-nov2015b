

{
	const MAX_JUMPS 6
	const BONE_BEAM_WIDTH 5
	const JUMP_BEAM_WIDTH 10

	const SOUND_IDLEZAP1 debris/zap4.wav
	const SOUND_IDLEZAP2 debris/zap2.wav
	const SOUND_IDLEZAP3 debris/zap5.wav
	const SOUND_ZAP_TARG magic/lightning_strike2.wav
}

{ client_activate 
	setvard FX_OWNER PARAM1
	local FX_ORIGIN PARAM2
	local FX_YAW PARAM3

	setcallback render enable

	local FIRST_TARG PARAM4



	setvard TARG_IS_ENT 1
	if ( FIRST_TARG == -1 ) setvard TARG_IS_ENT 0
	setvard GOT_NEW_TARG 0
	setvard SWIRL_ROT 0

	setvard N_JUMPS 0
	
	if ( !TARG_IS_ENT )
	{
		setvard BEAM_TARG FX_ORIGIN
		setvard OLD_TARG BEAM_TARG
		vectoradd BEAM_TARG $relpos($vec(0,FX_YAW,0),$vec(0,128,0))
		vectorset BEAM_TARG z $get_ground_height(BEAM_TARG)
		vectoradd BEAM_TARG z 32
		cleffect beam_points FX_ORIGIN BEAM_TARG lgtning.spr 1.0 JUMP_BEAM_WIDTH 1 255 255 30 (255,64,0)
		setvard SWIRL_ACTIVE 1
		setvard STATIC_ACTIVE 0
		callevent 1.0 beam_get_svtarg
		callevent 2.0 beam_jump
	}
	else
	{
		setvard BEAM_TARG FIRST_TARG
		setvard OLD_TARG BEAM_TARG
		cleffect beam_end FIRST_TARG 1 FX_ORIGIN lgtning.spr 1.0 JUMP_BEAM_WIDTH 1 255 255 30 (255,64,0)
		setvard SWIRL_ACTIVE 0
		setvard STATIC_ACTIVE 1
		callevent 1.0 beam_get_svtarg
		callevent 2.0 beam_jump
	}

	
	
	


	setvard FX_ACTIVE 1
	callevent fx_loop

	callevent 120.0 end_fx 
}

{ game_prerender
	if FX_ACTIVE
	if ( STATIC_ACTIVE )
	{
		local RND_BONE $rand(1,10)
		local BONE1_ORG $getcl(BEAM_TARG,bonepos,RND_BONE)
		local RND_BONE $rand(1,10)
		local BONE2_ORG $getcl(BEAM_TARG,bonepos,RND_BONE)

		

		
		if ( BONE1_ORG equals $vec(0,0,0) ) local BONE1_ORG $getcl(BEAM_TARG,origin)
		if ( BONE2_ORG equals $vec(0,0,0) ) local BONE2_ORG $getcl(BEAM_TARG,origin)
		if ( BONE2_ORG equals BONE1_ORG )
		{
			vectoradd BONE2_ORG $relpos($vec(0,$randf(0,359),0),$vec($randf(-48,48),$randf(-48,48),0)
		}
		
		cleffect beam_points BONE1_ORG BONE2_ORG lgtning.spr 0.001 BONE_BEAM_WIDTH 1 255 255 30 (255,64,0)
	}
}

{ fx_loop
	if FX_ACTIVE

	callevent 0.05 fx_loop

	

	if SWIRL_ACTIVE
	
	local BEAM_START BEAM_TARG
	local BEAM_END BEAM_START
	add SWIRL_ROT 40
	if ( SWIRL_ROT > 359 ) setvard SWIRL_ROT 0
	vectoradd BEAM_END $relpos($vec(0,SWIRL_ROT,0),$vec(0,15,2))
	if ( SNAP_GROUND )
	{
		setvard SNAP_GROUND 0
		vectorset BEAM_END z $get_ground_height(BEAM_END)
	}
	cleffect beam_points BEAM_START BEAM_END lgtning.spr 1.0 BONE_BEAM_WIDTH 1 255 255 30 (255,64,0)
	setvard BEAM_TARG BEAM_END
}

{ sv_sends_index 
	setvard BEAM_SV_IDX PARAM1
}

{ beam_get_svtarg
	if game.localplayer.index equals FX_OWNER
	if ( TARG_IS_ENT )
	{
		local REPORT_ORG $getcl(BEAM_TARG,origin)
	}
	else
	{
		local REPORT_ORG BEAM_TARG
	}

	
	cleffect ce player ext_jump_beam $quote(REPORT_ORG) TARG_IS_ENT $quote(BEAM_TARG) BEAM_SV_IDX x
}

{ update_targ 


	if !GOT_NEW_TARG
	setvard GOT_NEW_TARG 1
	setvard NEW_TARG PARAM1

	if ( NEW_TARG == -1 ) callevent random_jump 
}

{ random_jump


	if ( TARG_IS_ENT )
	{
		setvard OLD_TARG $getcl(BEAM_TARG,origin)
	}
	else
	{
		setvard OLD_TARG BEAM_TARG
	}



	setvard NEW_TARG OLD_TARG
	vectoradd NEW_TARG $relpos($vec(0,$randf(0,359),0),$vec(0,256,32))
	local TRACE_START OLD_TARG
	local TRACE_END NEW_TARG
	local TRACE_LINE $get_traceline(TRACE_START,TRACE_END,clworld)
	setvard NEW_TARG TRACE_LINE


}

{ beam_jump

	if FX_ACTIVE

	

	if ( N_JUMPS >= MAX_JUMPS )
	{
		
		callevent end_fx
		local EXIT_SUB 1
	}
	if !EXIT_SUB

	

	setvard STATIC_ACTIVE 0
	setvard SWIRL_ACTIVE 0

	add N_JUMPS 1

	local WAS_ENT TARG_IS_ENT

	if ( TARG_IS_ENT )
	{
		setvard OLD_TARG $getcl(BEAM_TARG,origin)
	}
	else
	{
		setvard OLD_TARG BEAM_TARG
	}

	

	if ( !GOT_NEW_TARG )
	{
		
		
		callevent random_jump
	}
	setvard GOT_NEW_TARG 0

	

	setvard BEAM_TARG NEW_TARG

	

	if ( BEAM_TARG startswith '(' )
	{
		setvard TARG_IS_ENT 0
	}
	else
	{
		setvard TARG_IS_ENT 1
	}

	


	

	if ( WAS_ENT ) vectoradd OLD_TARG z 32 

	if ( !TARG_IS_ENT )
	{
		setvard BEAM_TARG OLD_TARG
		vectoradd BEAM_TARG $relpos($vec(0,$randf(0,359),0),$vec(0,128,0))
		vectorset BEAM_TARG z $get_ground_height(BEAM_TARG)
		vectoradd BEAM_TARG z 32
		cleffect beam_points OLD_TARG BEAM_TARG lgtning.spr 1.0 JUMP_BEAM_WIDTH 1 255 255 30 (255,64,0)
		setvard SWIRL_ACTIVE 1
		setvard SNAP_GROUND 1
		setvard STATIC_ACTIVE 0
		callevent 1.0 beam_get_svtarg
		callevent 2.0 beam_jump
	}
	else
	{
		
		if ( game.localplayer.index equals FX_OWNER )
		{
			cleffect ce player ext_jump_beam_burn BEAM_SV_IDX x
		}

		cleffect beam_end BEAM_TARG 1 OLD_TARG lgtning.spr 1.0 JUMP_BEAM_WIDTH 1 255 255 30 (255,64,0)
		setvard SWIRL_ACTIVE 0
		setvard STATIC_ACTIVE 1
		callevent 1.0 beam_get_svtarg
		callevent 2.0 beam_jump
	}

	if ( BEAM_TARG startswith '(' )
	{
		local SOUND_ORG BEAM_TARG
	}
	else
	{
		local SOUND_ORG $getcl(BEAM_TARG,origin)
	}

	if ( SWIRL_ACTIVE )
	{

		local RND_ZAP $rand(1,3)
		if ( RND_ZAP == 1 ) sound.play3d SOUND_IDLEZAP1 10 SOUND_ORG
		if ( RND_ZAP == 2 ) sound.play3d SOUND_IDLEZAP2 10 SOUND_ORG
		if ( RND_ZAP == 3 ) sound.play3d SOUND_IDLEZAP3 10 SOUND_ORG
	}
	else
	{
		local RND_ZAP $rand(1,3)
		if ( RND_ZAP == 1 ) sound.play3d SOUND_ZAP_TARG 10 SOUND_ORG
	}

	

	
}

{ end_fx

	if ( game.localplayer.index equals FX_OWNER )
	{
		if !TOLD_PLAYER_ENDED
		setvard TOLD_PLAYER_ENDED 1
		cleffect ce player ext_jump_beam_end
	}
	setvard FX_ACTIVE 0
	callevent 1.0 remove_fx
}

{ remove_fx
	removescript
}
